<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluaci√≥n Ciberseguridad</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --danger: #dc2626;
            --secondary: #64748b;
            --bg: #f8fafc;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg);
            color: #1e293b;
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        h1 {
            text-align: center;
            color: var(--primary);
            margin-bottom: 30px;
        }

        /* Selector de Grupo */
        .control-panel {
            background: #eff6ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between; /* Espacio entre select y loading */
            gap: 15px;
            border: 1px solid #bfdbfe;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-grow: 1;
        }

        select {
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 6px;
            border: 1px solid #cbd5e1;
            cursor: pointer;
            flex-grow: 1;
            max-width: 300px;
        }

        #loadingIndicator {
            color: var(--primary);
            font-weight: bold;
            display: none; /* Oculto por defecto */
        }

        /* Tabla R√∫brica */
        .rubrica-section {
            margin-bottom: 40px;
        }
        
        .section-title {
            background: #f1f5f9;
            padding: 10px 15px;
            border-left: 5px solid var(--primary);
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 1.1em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th {
            background: #f8fafc;
            padding: 12px;
            text-align: center;
            border-bottom: 2px solid var(--border);
            color: #64748b;
            font-weight: 600;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }

        .col-criterio { width: 20%; font-weight: 600; }
        .col-desc { width: 30%; font-size: 0.9em; color: #475569; }
        
        /* Celdas de puntuaci√≥n */
        .score-cell {
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            width: 10%;
            font-weight: bold;
            color: #94a3b8;
        }

        .score-cell:hover {
            background-color: #f0f9ff;
        }

        /* Estilo cuando est√° seleccionado */
        .selected {
            background-color: var(--primary) !important;
            color: white !important;
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgb(0 0 0 / 0.1);
            border-radius: 6px;
        }

        /* Botonera inferior */
        .actions-panel {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
            flex: 1;
        }

        .btn-save {
            background-color: var(--success);
            color: white;
            flex: 2; /* M√°s grande */
        }
        .btn-save:hover { background-color: #15803d; }
        .btn-save:disabled { background-color: #cbd5e1; cursor: not-allowed; }

        .btn-clear {
            background-color: var(--secondary);
            color: white;
            flex: 1;
        }
        .btn-clear:hover { background-color: #475569; }

        /* Mensajes */
        #statusMessage {
            text-align: center;
            margin-top: 15px;
            font-weight: bold;
            min-height: 24px;
        }

        .header-scores th {
            font-size: 0.8em;
            text-transform: uppercase;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Evaluaci√≥n de Ciberseguridad</h1>

    <!-- Panel de Selecci√≥n -->
    <div class="control-panel">
        <div class="control-group">
            <label for="grupoSelect"><strong>Grupo:</strong></label>
            <select id="grupoSelect" onchange="cargarDatosGrupo()">
                <option value="" disabled selected>-- Elige un grupo --</option>
                <option value="GRUPO1">GRUPO 1</option>
                <option value="GRUPO2">GRUPO 2</option>
                <option value="GRUPO3">GRUPO 3</option>
                <option value="GRUPO4">GRUPO 4</option>
                <option value="GRUPO5">GRUPO 5</option>
                <option value="GRUPO6">GRUPO 6</option>
            </select>
        </div>
        <div id="loadingIndicator">üîÑ Cargando notas...</div>
    </div>

    <!-- R√öBRICA 1: TRABAJO ESCRITO (Filas 2, 3, 4 en Excel) -->
    <div class="rubrica-section">
        <div class="section-title">PARTE 1: TRABAJO ESCRITO</div>
        <table>
            <thead>
                <tr class="header-scores">
                    <th class="col-criterio">Criterio</th>
                    <th class="col-desc">Descripci√≥n</th>
                    <th>1<br><small>Muy Mal</small></th>
                    <th>2<br><small>Mal</small></th>
                    <th>3<br><small>Regular</small></th>
                    <th>4<br><small>Bien</small></th>
                    <th>5<br><small>Muy Bien</small></th>
                </tr>
            </thead>
            <tbody>
                <!-- √çTEM 1 (Fila 2) -->
                <tr class="fila-evaluacion" data-index="0">
                    <td>Dominio del Tema</td>
                    <td class="col-desc">Demuestra un entendimiento completo y profundo de todos los conceptos asignados, usando la terminolog√≠a correcta</td>
                    <td class="score-cell" onclick="selectScore(0, 1)">1</td>
                    <td class="score-cell" onclick="selectScore(0, 2)">2</td>
                    <td class="score-cell" onclick="selectScore(0, 3)">3</td>
                    <td class="score-cell" onclick="selectScore(0, 4)">4</td>
                    <td class="score-cell" onclick="selectScore(0, 5)">5</td>
                </tr>
                <!-- √çTEM 2 (Fila 3) -->
                <tr class="fila-evaluacion" data-index="1">
                    <td>Investigaci√≥n y Uso de Fuentes</td>
                    <td class="col-desc">Integra de forma eficaz la web de la asignatura y los recursos externos recomendados para enriquecer el an√°lisis.</td>
                    <td class="score-cell" onclick="selectScore(1, 1)">1</td>
                    <td class="score-cell" onclick="selectScore(1, 2)">2</td>
                    <td class="score-cell" onclick="selectScore(1, 3)">3</td>
                    <td class="score-cell" onclick="selectScore(1, 4)">4</td>
                    <td class="score-cell" onclick="selectScore(1, 5)">5</td>
                </tr>
                <!-- √çTEM 3 (Fila 4) -->
                <tr class="fila-evaluacion" data-index="2">
                    <td>An√°lisis del Caso Real</td>
                    <td class="col-desc">El caso es relevante, est√° bien explicado y se conecta de forma cr√≠tica con la teor√≠a, demostrando comprensi√≥n.</td>
                    <td class="score-cell" onclick="selectScore(2, 1)">1</td>
                    <td class="score-cell" onclick="selectScore(2, 2)">2</td>
                    <td class="score-cell" onclick="selectScore(2, 3)">3</td>
                    <td class="score-cell" onclick="selectScore(2, 4)">4</td>
                    <td class="score-cell" onclick="selectScore(2, 5)">5</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- R√öBRICA 2: EXPOSICI√ìN (Filas 7, 8, 9 en Excel) -->
    <div class="rubrica-section">
        <div class="section-title">PARTE 2: EXPOSICI√ìN ORAL</div>
        <table>
            <thead>
                <tr class="header-scores">
                    <th class="col-criterio">Criterio</th>
                    <th class="col-desc">Descripci√≥n</th>
                    <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>
                </tr>
            </thead>
            <tbody>
                <!-- √çTEM 4 (Fila 7) -->
                <tr class="fila-evaluacion" data-index="3">
                    <td>Claridad y Estructura</td>
                    <td class="col-desc">La exposici√≥n es l√≥gica, clara y f√°cil de seguir para la audiencia, sin divagaciones</td>
                    <td class="score-cell" onclick="selectScore(3, 1)">1</td>
                    <td class="score-cell" onclick="selectScore(3, 2)">2</td>
                    <td class="score-cell" onclick="selectScore(3, 3)">3</td>
                    <td class="score-cell" onclick="selectScore(3, 4)">4</td>
                    <td class="score-cell" onclick="selectScore(3, 5)">5</td>
                </tr>
                <!-- √çTEM 5 (Fila 8) -->
                <tr class="fila-evaluacion" data-index="4">
                    <td>Comunicaci√≥n Oral</td>
                    <td class="col-desc">El equipo se expresa con fluidez y confianza. El tiempo est√° bien distribuido y todos participan.</td>
                    <td class="score-cell" onclick="selectScore(4, 1)">1</td>
                    <td class="score-cell" onclick="selectScore(4, 2)">2</td>
                    <td class="score-cell" onclick="selectScore(4, 3)">3</td>
                    <td class="score-cell" onclick="selectScore(4, 4)">4</td>
                    <td class="score-cell" onclick="selectScore(4, 5)">5</td>
                </tr>
                <!-- √çTEM 6 (Fila 9) -->
                <tr class="fila-evaluacion" data-index="5">
                    <td>Recursos Visuales</td>
                    <td class="col-desc">El material de apoyo (diapositivas, etc.) es visualmente atractivo, claro y refuerza el mensaje.</td>
                    <td class="score-cell" onclick="selectScore(5, 1)">1</td>
                    <td class="score-cell" onclick="selectScore(5, 2)">2</td>
                    <td class="score-cell" onclick="selectScore(5, 3)">3</td>
                    <td class="score-cell" onclick="selectScore(5, 4)">4</td>
                    <td class="score-cell" onclick="selectScore(5, 5)">5</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="actions-panel">
        <button class="btn btn-clear" onclick="limpiarFormulario()">Limpiar Selecci√≥n</button>
        <button id="btnGuardar" class="btn btn-save" onclick="enviarDatos()">Guardar / Actualizar Evaluaci√≥n</button>
    </div>
    <div id="statusMessage"></div>

</div>

<script>
    // ==========================================
    // CONFIGURACI√ìN - PEGA TU NUEVA URL AQU√ç
    // ==========================================
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzadxsaMgtlKYYfN56CeF0D9vKHBhCT-XIdLN8xFzsm-0a97HS3OBo4VdRFc9arxX7a/exec"; 
    
    // Estado de la aplicaci√≥n
    let valoraciones = [null, null, null, null, null, null];

    // Funci√≥n para marcar celda
    function selectScore(filaIndex, valor) {
        valoraciones[filaIndex] = valor;
        actualizarUI();
    }

    // Funci√≥n que pinta la tabla seg√∫n el array 'valoraciones'
    function actualizarUI() {
        // Limpiamos todo primero
        document.querySelectorAll('.score-cell').forEach(c => c.classList.remove('selected'));

        // Re-aplicamos las clases
        valoraciones.forEach((valor, index) => {
            if (valor !== null) {
                const fila = document.querySelector(`tr[data-index="${index}"]`);
                if(fila) {
                    const celda = fila.querySelectorAll('.score-cell')[valor - 1];
                    if(celda) celda.classList.add('selected');
                }
            }
        });
    }

    // Limpia el formulario (reseteo local)
    function limpiarFormulario() {
        valoraciones = [null, null, null, null, null, null];
        actualizarUI();
        document.getElementById('statusMessage').textContent = "üßπ Formulario limpio (no guardado en Excel a√∫n).";
        document.getElementById('statusMessage').style.color = "#64748b";
    }

    // Carga los datos del grupo seleccionado
    function cargarDatosGrupo() {
        const grupo = document.getElementById('grupoSelect').value;
        const loader = document.getElementById('loadingIndicator');
        const msg = document.getElementById('statusMessage');

        if (!grupo) return;

        // Reset visual antes de cargar
        limpiarFormulario();
        msg.textContent = "";
        
        loader.style.display = "block";

        // Petici√≥n GET para leer datos
        // Nota: fetch sin 'no-cors' permite leer la respuesta JSON
        fetch(`${SCRIPT_URL}?grupo=${grupo}`)
            .then(response => response.json())
            .then(data => {
                loader.style.display = "none";
                if (data.status === 'success') {
                    // Actualizamos el array con lo que viene del Excel
                    // Si viene null (no evaluado), se queda null
                    valoraciones = data.data;
                    actualizarUI();
                    
                    // Comprobar si est√° vac√≠a
                    const hayDatos = valoraciones.some(v => v !== null);
                    if(hayDatos) {
                        msg.textContent = "‚úÖ Notas cargadas desde la hoja.";
                        msg.style.color = "green";
                    } else {
                        msg.textContent = "‚ÑπÔ∏è Este grupo a√∫n no tiene evaluaci√≥n.";
                        msg.style.color = "#2563eb";
                    }
                } else {
                    msg.textContent = "‚ùå Error leyendo datos: " + data.message;
                    msg.style.color = "red";
                }
            })
            .catch(error => {
                console.error(error);
                loader.style.display = "none";
                msg.textContent = "‚ùå Error de conexi√≥n al cargar.";
                msg.style.color = "red";
            });
    }

    // Guardar datos
    function enviarDatos() {
        const grupo = document.getElementById('grupoSelect').value;
        const btn = document.getElementById('btnGuardar');
        const msg = document.getElementById('statusMessage');

        if (!grupo) {
            msg.textContent = "‚ö†Ô∏è Selecciona un grupo.";
            msg.style.color = "red";
            return;
        }
        if (valoraciones.includes(null)) {
            msg.textContent = "‚ö†Ô∏è Faltan campos por evaluar.";
            msg.style.color = "red";
            return;
        }

        btn.disabled = true;
        btn.textContent = "Guardando...";
        msg.textContent = "";

        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ grupo: grupo, valoraciones: valoraciones })
        })
        .then(() => {
            msg.textContent = "‚úÖ Guardado correctamente.";
            msg.style.color = "green";
            btn.disabled = false;
            btn.textContent = "Guardar / Actualizar Evaluaci√≥n";
        })
        .catch(error => {
            msg.textContent = "‚ùå Error al guardar.";
            msg.style.color = "red";
            btn.disabled = false;
        });
    }
</script>

</body>
</html>